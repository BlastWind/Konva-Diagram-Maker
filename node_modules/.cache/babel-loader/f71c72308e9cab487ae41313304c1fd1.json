{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar Factory_1 = require(\"../Factory\");\n\nvar Node_1 = require(\"../Node\");\n\nvar Validators_1 = require(\"../Validators\");\n\nfunction pixelAt(idata, x, y) {\n  var idx = (y * idata.width + x) * 4;\n  var d = [];\n  d.push(idata.data[idx++], idata.data[idx++], idata.data[idx++], idata.data[idx++]);\n  return d;\n}\n\nfunction rgbDistance(p1, p2) {\n  return Math.sqrt(Math.pow(p1[0] - p2[0], 2) + Math.pow(p1[1] - p2[1], 2) + Math.pow(p1[2] - p2[2], 2));\n}\n\nfunction rgbMean(pTab) {\n  var m = [0, 0, 0];\n\n  for (var i = 0; i < pTab.length; i++) {\n    m[0] += pTab[i][0];\n    m[1] += pTab[i][1];\n    m[2] += pTab[i][2];\n  }\n\n  m[0] /= pTab.length;\n  m[1] /= pTab.length;\n  m[2] /= pTab.length;\n  return m;\n}\n\nfunction backgroundMask(idata, threshold) {\n  var rgbv_no = pixelAt(idata, 0, 0);\n  var rgbv_ne = pixelAt(idata, idata.width - 1, 0);\n  var rgbv_so = pixelAt(idata, 0, idata.height - 1);\n  var rgbv_se = pixelAt(idata, idata.width - 1, idata.height - 1);\n  var thres = threshold || 10;\n\n  if (rgbDistance(rgbv_no, rgbv_ne) < thres && rgbDistance(rgbv_ne, rgbv_se) < thres && rgbDistance(rgbv_se, rgbv_so) < thres && rgbDistance(rgbv_so, rgbv_no) < thres) {\n    var mean = rgbMean([rgbv_ne, rgbv_no, rgbv_se, rgbv_so]);\n    var mask = [];\n\n    for (var i = 0; i < idata.width * idata.height; i++) {\n      var d = rgbDistance(mean, [idata.data[i * 4], idata.data[i * 4 + 1], idata.data[i * 4 + 2]]);\n      mask[i] = d < thres ? 0 : 255;\n    }\n\n    return mask;\n  }\n}\n\nfunction applyMask(idata, mask) {\n  for (var i = 0; i < idata.width * idata.height; i++) {\n    idata.data[4 * i + 3] = mask[i];\n  }\n}\n\nfunction erodeMask(mask, sw, sh) {\n  var weights = [1, 1, 1, 1, 0, 1, 1, 1, 1];\n  var side = Math.round(Math.sqrt(weights.length));\n  var halfSide = Math.floor(side / 2);\n  var maskResult = [];\n\n  for (var y = 0; y < sh; y++) {\n    for (var x = 0; x < sw; x++) {\n      var so = y * sw + x;\n      var a = 0;\n\n      for (var cy = 0; cy < side; cy++) {\n        for (var cx = 0; cx < side; cx++) {\n          var scy = y + cy - halfSide;\n          var scx = x + cx - halfSide;\n\n          if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {\n            var srcOff = scy * sw + scx;\n            var wt = weights[cy * side + cx];\n            a += mask[srcOff] * wt;\n          }\n        }\n      }\n\n      maskResult[so] = a === 255 * 8 ? 255 : 0;\n    }\n  }\n\n  return maskResult;\n}\n\nfunction dilateMask(mask, sw, sh) {\n  var weights = [1, 1, 1, 1, 1, 1, 1, 1, 1];\n  var side = Math.round(Math.sqrt(weights.length));\n  var halfSide = Math.floor(side / 2);\n  var maskResult = [];\n\n  for (var y = 0; y < sh; y++) {\n    for (var x = 0; x < sw; x++) {\n      var so = y * sw + x;\n      var a = 0;\n\n      for (var cy = 0; cy < side; cy++) {\n        for (var cx = 0; cx < side; cx++) {\n          var scy = y + cy - halfSide;\n          var scx = x + cx - halfSide;\n\n          if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {\n            var srcOff = scy * sw + scx;\n            var wt = weights[cy * side + cx];\n            a += mask[srcOff] * wt;\n          }\n        }\n      }\n\n      maskResult[so] = a >= 255 * 4 ? 255 : 0;\n    }\n  }\n\n  return maskResult;\n}\n\nfunction smoothEdgeMask(mask, sw, sh) {\n  var weights = [1 / 9, 1 / 9, 1 / 9, 1 / 9, 1 / 9, 1 / 9, 1 / 9, 1 / 9, 1 / 9];\n  var side = Math.round(Math.sqrt(weights.length));\n  var halfSide = Math.floor(side / 2);\n  var maskResult = [];\n\n  for (var y = 0; y < sh; y++) {\n    for (var x = 0; x < sw; x++) {\n      var so = y * sw + x;\n      var a = 0;\n\n      for (var cy = 0; cy < side; cy++) {\n        for (var cx = 0; cx < side; cx++) {\n          var scy = y + cy - halfSide;\n          var scx = x + cx - halfSide;\n\n          if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {\n            var srcOff = scy * sw + scx;\n            var wt = weights[cy * side + cx];\n            a += mask[srcOff] * wt;\n          }\n        }\n      }\n\n      maskResult[so] = a;\n    }\n  }\n\n  return maskResult;\n}\n\nexports.Mask = function (imageData) {\n  var threshold = this.threshold(),\n      mask = backgroundMask(imageData, threshold);\n\n  if (mask) {\n    mask = erodeMask(mask, imageData.width, imageData.height);\n    mask = dilateMask(mask, imageData.width, imageData.height);\n    mask = smoothEdgeMask(mask, imageData.width, imageData.height);\n    applyMask(imageData, mask);\n  }\n\n  return imageData;\n};\n\nFactory_1.Factory.addGetterSetter(Node_1.Node, 'threshold', 0, Validators_1.getNumberValidator(), Factory_1.Factory.afterSetFilter);","map":null,"metadata":{},"sourceType":"script"}